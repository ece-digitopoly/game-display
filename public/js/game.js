all_props = [{"name": "start_and_go"},
             {"name": "mediterranean",
              "price": "$60",
              "color": "#964bbf",
              "displayname":"MEDITERRANEAN AVE.",
              "rent": "$2",
              "house1": "$10",
              "house2": "$30",
              "house3": "$90",
              "house4": "$160",
              "hotel": "$250",
              "mortgage": "$30",
              "housecost": "$50",
              "posthotel": "$50"
             },
             {"name": "communitychest1"},
             {"name": "baltic",
              "price": "$60",
             "color": "#964bbf",
             "displayname":"BALTIC AVE.",
             "rent": "$4",
             "house1": "$20",
             "house2": "$60",
             "house3": "$180",
             "house4": "$320",
             "hotel": "$450",
             "mortgage": "$30",
             "housecost": "$50",
             "posthotel": "$50"
             },
             {"name": "incometax", "tax": "$200"},
             {"name": "readingrr", 
              "displayname": "Reading Railroad",
              "price": "$200", 
              "mortage":"100"},      // 24
             {"name": "oriental",
             "color": "#5bf2f5",
             "displayname":"ORIENTAL AVE.",
             "rent": "$6",
             "house1": "$30",
             "house2": "$90",
             "house3": "$270",
             "house4": "$400",
             "hotel": "$550",
             "mortgage": "$50",
             "housecost": "$50",
             "posthotel": "$50"
             },
             {"name": "chance1"},
             {"name": "vermont",
              "price": "$100",
             "color": "#5bf2f5",
             "displayname":"VERMONT AVE.",
             "rent": "$6",
             "house1": "$30",
             "house2": "$90",
             "house3": "$270",
             "house4": "$400",
             "hotel": "$550",
             "mortgage": "$50",
             "housecost": "$50",
             "posthotel": "$50"
             },
             {"name": "connecticut",
              "price": "$100",
             "color": "#5bf2f5",
             "displayname":"CONNECTICUT AVE.",
             "rent": "$8",
             "house1": "$40",
             "house2": "$100",
             "house3": "$300",
             "house4": "$450",
             "hotel": "$600",
             "mortgage": "$60",
             "housecost": "$50",
             "posthotel": "$50"
             },
             {"name": "jail"},
             {"name": "stcharles",
              "price": "$120",
               "color": "#964bbf",
               "displayname":"ST. CHARLES PLACE",
               "rent": "$10",
               "house1": "$50",
               "house2": "$150",
               "house3": "$450",
               "house4": "$625",
               "hotel": "$750",
               "mortgage": "$70",
               "housecost": "$100",
               "posthotel": "$100"
              },
              {"name": "electricco",  // 23
              "price": "$140",
               "displayname":"ELECTRIC CO.",
               "mortgage": "75",
              },
              {"name": "statesave",
              "price": "$150",
               "color": "#964bbf",
               "displayname":"STATES AVE.",
               "rent": "$10",
               "house1": "$50",
               "house2": "$150",
               "house3": "$450",
               "house4": "$625",
               "hotel": "$750",
               "mortgage": "$70",
               "housecost": "$100",
               "posthotel": "$100"
              },
              {"name": "virginia",
              "price": "$160",
               "color": "#964bbf",
               "displayname":"VIRGINIA AVE.",
               "rent": "$12",
               "house1": "$60",
               "house2": "$180",
               "house3": "$500",
               "house4": "$700",
               "hotel": "$900",
               "mortgage": "$80",
               "housecost": "$100",
               "posthotel": "$100"
              },
              {"name": "pennsylvaniarr",
               "displayname": "Pennsylvania Railroad",
               "price": "$200",
               "mortage":"100"},
              {"name": "stjames",
               "color": "#eb9e34",
               "displayname":"ST. JAMES PLACE",
               "rent": "$14",
               "house1": "$70",
               "house2": "$200",
               "house3": "$550",
               "house4": "$750",
               "hotel": "$950",
               "mortgage": "$90",
               "housecost": "$100",
               "posthotel": "$100"
              },
              {"name": "communitychest"},
              {"name": "tennessee",
              "price": "$180",
               "color": "#eb9e34",
               "displayname":"TENNESSEE AVE.",
               "rent": "$14",
               "house1": "$70",
               "house2": "$200",
               "house3": "$550",
               "house4": "$750",
               "hotel": "$950",
               "mortgage": "$90",
               "housecost": "$100",
               "posthotel": "$100"
              },
              {"name": "newyork",
              "price": "$180",
               "color": "#eb9e34",
               "displayname":"NEW YORK AVE.",
               "rent": "$16",
               "house1": "$80",
               "house2": "$220",
               "house3": "$600",
               "house4": "$800",
               "hotel": "$1000",
               "mortgage": "$100",
               "housecost": "$100",
               "posthotel": "$100"
              },
              {"name": "freeparking"},
              {"name": "kentucky",
              "price": "$200",
               "color": "#f2322c",
               "displayname":"KENTUCKY AVE.",
               "rent": "$18",
               "house1": "$90",
               "house2": "$250",
               "house3": "$700",
               "house4": "$875",
               "hotel": "$1050",
               "mortgage": "$110",
               "housecost": "$150",
               "posthotel": "$150"
              },
              {"name": "chancecard"},
              {"name": "indiana",
              "price": "$220",
               "color": "#f2322c",
               "displayname":"INDIANA AVE.",
               "rent": "$18",
               "house1": "$90",
               "house2": "$250",
               "house3": "$700",
               "house4": "$875",
               "hotel": "$1050",
               "mortgage": "$110",
               "housecost": "$150",
               "posthotel": "$150"
              },
              {"name": "illinois",
              "price": "$220",
               "color": "#f2322c",
               "displayname":"ILLINOIS AVE.",
               "rent": "$20",
               "house1": "$100",
               "house2": "$300",
               "house3": "$750",
               "house4": "$925",
               "hotel": "$1100",
               "mortgage": "$120",
               "housecost": "$150",
               "posthotel": "$150"
              },
              {"name": "borailroad",
               "displayname": "B&O Railroad",
               "price": "$240", 
               "mortage": "100"},     // 26
              {"name": "atlantic",
              "price": "$200",
               "color": "#fff769",
               "displayname":"ATLANTIC AVE.",
               "rent": "$22",
               "house1": "$110",
               "house2": "$330",
               "house3": "$800",
               "house4": "$975",
               "hotel": "$1150",
               "mortgage": "$130",
               "housecost": "$150",
               "posthotel": "$150"
              },
              {"name": "ventnor",
              "price": "$260",
              "color": "#fff769",
              "displayname":"VENTNOR AVE.",
              "rent": "$22",
              "house1": "$110",
              "house2": "$330",
              "house3": "$800",
              "house4": "$975",
              "hotel": "$1150",
              "mortgage": "$130",
              "housecost": "$150",
              "posthotel": "$150"
             },
             {"name": "waterworks",  // 22
              "price": "$150",
                    "displayname":"WATER WORKS",
                    "mortgage": "75",
             },
             {"name": "marvin",
              "price": "$280",
               "color": "#fff769",
               "displayname":"MARVIN GARDENS",
               "rent": "$24",
               "house1": "$120",
               "house2": "$360",
               "house3": "$850",
               "house4": "$1025",
               "hotel": "$1200",
               "mortgage": "$140",
               "housecost": "$150",
               "posthotel": "$150"
             },
             {"name": "gotojail"},
             {"name": "pacific",
              "price": "$300",
               "color": "#00b04f",
               "displayname":"PACIFIC AVE.",
               "rent": "$26",
               "house1": "$130",
               "house2": "$390",
               "house3": "$900",
               "house4": "$1100",
               "hotel": "$1275",
               "mortgage": "$150",
               "housecost": "$200",
               "posthotel": "$200"
              },
              {"name": "northcarolina",
              "price": "$300",
               "color": "#00b04f",
               "displayname":"NORTH CAROLINA AVE.",
               "rent": "$26",
               "house1": "$130",
               "house2": "$390",
               "house3": "$900",
               "house4": "$1100",
               "hotel": "$1275",
               "mortgage": "$150",
               "housecost": "$200",
               "posthotel": "$200"
              },
              {"name": "communitychest2"},
              {"name": "pennsylvania",
              "price": "$320",
               "color": "#00b04f",
               "displayname":"PENNSYLVANIA AVE.",
               "rent": "$28",
               "house1": "$150",
               "house2": "$450",
               "house3": "$1000",
               "house4": "$1200",
               "hotel": "$1400",
               "mortgage": "$160",
               "housecost": "$200",
               "posthotel": "$200"
              },
              {"name": "shortlinerr", 
               "displayname": "Short Line Railroad", 
               "price": "$200", "mortage": "100"},    // 27
              {"name": "chance2"},
              {"name": "parkplace",
              "price": "$350",
               "color": "#024abf",
               "displayname":"PARK PLACE",
               "rent": "$35",
               "house1": "$175",
               "house2": "$500",
               "house3": "$1100",
               "house4": "$1300",
               "hotel": "$1500",
               "mortgage": "$175",
               "housecost": "$200",
               "posthotel": "$200"
              },
              {"name": "luxurytax", "tax": "$75"},
              {"name": "boardwalk",
              "price": "$400",
               "color": "#024abf",
               "displayname":"BOARDWALK",
               "rent": "$50",
               "house1": "$200",
               "house2": "$600",
               "house3": "$1400",
               "house4": "$1700",
               "hotel": "$2000",
               "mortgage": "$200",
               "housecost": "$200",
               "posthotel": "$200"
              }]
                
railway = [
            ["Rent", 25],  //rent 
            ["Own 2 railroads", 50],  //own 2 rr's
            ["Own 3 railroads", 100], //own 3 rr's 
            ["Own 4 railroads", 200], //own 4 rr's 
            ["Mortage Value", 100], //mortgage
            ]

prop_name_list = all_props.map (elm => elm.name)
prop_dname_list = prop_name_list = all_props.map (elm => elm.displayname)

var DICE_ROLL = -1
var NEXT_POS = -1
var CURRENT_POSITION = [0, 0, 0, 0]     // for four players
var CURRENT_PLAYER = 0                  // zero index - 0, 1, 2, 3
var BOARD_STATE = "INIT"

var PLAYER_HOLDINGS = [
    [], // player 1
    [], // player 2
    [], // player 3
    []  // player 4
]

property_go         = 0
property_jail       = 10
property_gotojail   = 29
property_parking    = 19
property_taxes      = [4, 37]
property_community  = [2, 17, 32]
property_chance     = [7, 21, 35]
property_ownable    = [1, 3, 5, 6, 8, 9, 11, 12, 13, 14, 15,
                       16, 17, 18, 20, 22, 23, 24, 25, 26, 27,
                       28, 30, 31, 33, 34, 36, 38]

$.fn.classList = function() {return this[0].className.split(/\s+/);};

function init_board () {
    $("#diedialog").css ('display', 'flex')
    $("#landed_unowned_dialog").css ('display', 'none')
    $("#overlay").css ('opacity', 1)
    window.gameState = "GAME"
}
init_board()

function gamePlayKeyHandler (uartjson) {
    // console.log (uartjson ['action'])
    // console.log (uartjson ['direction'])
    if (uartjson ['action'] == 'scroll' && uartjson ['direction'] == 'up') {
        switch (BOARD_STATE) {
            case "PLAYERWAIT":
                if ($("#btn_buy").classList[0] == 'btn-hover') {
                    $("#btn_buy").toggleClass ('btn-hover btn')
                    $("#btn_ignore").toggleClass ('btn btn-hover')
                }
                else {
                    $("#btn_ignore").toggleClass ('btn-hover btn')
                    $("#btn_buy").toggleClass ('btn btn-hover')
                }
            break;
        }
    }
    else if (uartjson ['action'] == 'scroll' && uartjson ['direction'] == 'down')
    {
        switch (BOARD_STATE) {
            case "PLAYERWAIT":
                if ($("#btn_buy").classList[0] == 'btn-hover') {
                    $("#btn_ignore").toggleClass ('btn-hover btn')
                    $("#btn_buy").toggleClass ('btn btn-hover')
                }
                else {
                    $("#btn_buy").toggleClass ('btn-hover btn')
                    $("#btn_ignore").toggleClass ('btn btn-hover')
                }
            break;
        }
    }
    else if (uartjson ['action'] == 'click')
    {
        switch (BOARD_STATE) {
            case "PLAYERWAIT":
                if ($("#btn_buy").classList()[0] == 'btn-hover') {
                    // buy property
                    if (property_ownable.includes (NEXT_POS))
                        addPropertyToCurrentPlayer (NEXT_POS)
                }
                // else, ignore property, and move to next player
                // same action is performed even if player buys property
                CURRENT_PLAYER = CURRENT_PLAYER == 3 ? 0 : CURRENT_PLAYER + 1
            break;
        }
    }
}

function detectedDiceRoll () {
    BOARD_STATE = "DICEWAIT"
    $("#rolldie").attr ("src", "public/images/die.gif")
    $("#dialog1").html ("Dice roll detected!")
    $("#dialog2").html ("Waiting for roll...")
}

function handleDiceRoll (roll) {
    BOARD_STATE = "DICERECV"
    $("#rolldie").attr ("src", "public/images/die.png")
    $("#dialog1").html ("Dice roll received!")
    $("#dialog2").html ("Roll was " + roll + "!")

    DICE_ROLL = parseInt (roll)
    current_player_pos = CURRENT_POSITION [CURRENT_PLAYER]
    NEXT_POS = DICE_ROLL + current_player_pos > 27 ? (27 - DICE_ROLL + current_player_pos) : DICE_ROLL + current_player_pos
}

function addPropertyToCurrentPlayer (card) {
    // Extract money
    fund = parseInt ($("#fundtext" + (CURRENT_PLAYER + 1).toString()).html().match (/\$([0-9]+)/)[1])
    fund -= parseInt (all_props [NEXT_POS].price.match (/\$([0-9]+)/)[1])
    $("#fundtext" + (CURRENT_PLAYER + 1).toString()).html ("$" + fund.toString())
    
    if (PLAYER_HOLDINGS [CURRENT_PLAYER].length == 0) {
        $('#cards_' + (CURRENT_PLAYER + 1).toString()).children()[0].remove()
    }
    PLAYER_HOLDINGS [CURRENT_PLAYER].push (NEXT_POS)
    
    newcardwhole = document.createElement ("div"); newcardwhole.classList.add ("card")
    newcardtop = document.createElement ("div"); newcardtop.classList.add ("cardtop")
    newcard = document.createElement ("div"); newcard.classList.add ("cardbot")
    newcardtop.style ['background-color'] = all_props [NEXT_POS].color

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = all_props [NEXT_POS].displayname
    newcardtop.appendChild (newlabel) 

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Price:          " + all_props [NEXT_POS].price
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Rent with no houses:           " + all_props [NEXT_POS].rent
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Rent per house: " 
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML =   all_props [NEXT_POS].house1 + "/"
                         + all_props [NEXT_POS].house2 + "/"
                         + all_props [NEXT_POS].house3 + "/"
                         + all_props [NEXT_POS].house4
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Rent with a hotel:   " + all_props [NEXT_POS].hotel
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Mortgage:       " + all_props [NEXT_POS].mortgage
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Cost per house: " + all_props [NEXT_POS].housecost
    newcard.appendChild (newlabel)

    newlabel = document.createElement ("label"); newlabel.classList.add ("cardtext")
    newlabel.innerHTML = "Cost of hotel:  " + all_props [NEXT_POS].posthotel
    newcard.appendChild (newlabel)

    newcardwhole.appendChild (newcardtop)
    newcardwhole.appendChild (newcard)
    $('#cards_' + (CURRENT_PLAYER + 1).toString()).append (newcardwhole)
}

function landed_on_tile () {
    $("#unowned_card_title").html (prop_dname_list [NEXT_POS])
    $(".dialogcardtop").css ('background-color',   all_props [NEXT_POS].color)
    $("#dialog_price").html  ("Price:          " + all_props [NEXT_POS].price)
    $("#dialog_rent").html   ("Rent:           " + all_props [NEXT_POS].rent)
    $("#dialog_h1").html     ("With 1 house:   " + all_props [NEXT_POS].house1)
    $("#dialog_h2").html     ("With 2 houses:  " + all_props [NEXT_POS].house2)
    $("#dialog_h3").html     ("With 3 houses:  " + all_props [NEXT_POS].house3)
    $("#dialog_h4").html     ("With 4 houses:  " + all_props [NEXT_POS].house4)
    $("#dialog_hl").html     ("With a hotel:   " + all_props [NEXT_POS].hotel)
    $("#dialog_mort").html   ("Mortgage:       " + all_props [NEXT_POS].mortgage)
    $("#dialog_hc").html     ("Cost per house: " + all_props [NEXT_POS].housecost)
    $("#dialog_hotelc").html ("Cost of hotel:  " + all_props [NEXT_POS].posthotel)

    $("#overlay").css ('opacity', '0')
    $("#diedialog").css ('display', 'none')
    $("#landed_unowned_dialog").css ('display', 'flex')
    $("#overlay").css ('opacity', '1')

    $('#btn_buy').toggleClass ('btn btn-hover')
    BOARD_STATE = "PLAYERWAIT"
}
        
setTimeout (function () {
    uart_control ({"action": "dicerolling"})
}, 2000)

setTimeout (function () {
    uart_control ({"action": "diceroll", "roll": "9"})
}, 4000)    // Assume motor movement has started

setTimeout (function () {
    uart_control ({"action": "piecemoved"})
}, 6000)    // Assume motor movement has started

// no need to receive which card to show - dice roll will determine that
// technically, game logic is still given by microcontroller
// Hence logic handling by the Pi will be pipelined alongside micro's own logic,
// so the micro doesn't... well... micromanage the Pi.